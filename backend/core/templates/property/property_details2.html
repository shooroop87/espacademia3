{% extends 'base.html' %}
{% load static i18n %}

{% block title %}{{ property.name }} - espacademia{% endblock %}
{% block meta_description %}{{ property.meta_description|default:property.short_description }}{% endblock %}

{% block content %}
<!-- Page Title -->

     <div class="main-content">

            <div class="properties-details">
                <div class="sw-layout properties-thumbs-main" style="max-height: 620px;">
                    <div class="swiper swiper-initialized swiper-horizontal swiper-backface-hidden" style="max-height: 620px;" data-preview="2.04" data-tablet="1.6" data-mobile="1.1" data-mobile-sm="1.3" data-space-lg="20" data-space-md="15" data-space="10" data-slide-center="true" data-loop="true" data-init-slide="1">
                        <div class="swiper-wrapper" id="swiper-wrapper-8d755277c7abc148" aria-live="polite" style="transition-duration: 0ms; transform: translate3d(-2346.27px, 0px, 0px); transition-delay: 0ms;">
                            {% for image in property.images.all %}
                            <div class="swiper-slide" style="width: 926.078px; margin-right: 20px;" role="group" aria-label="{{ forloop.counter }} / {{ property.images.count }}" data-swiper-slide-index="{{ forloop.counter0 }}">
                                <div class="thumb-main">
                                    <a href="{{ image.image.url }}" data-fancybox="gallery" class="img-style">
                                        <img width="930" height="620" loading="eager" decoding="async" src="{{ image.image.url }}" alt="{{ property.name }}">
                                    </a>
                                    {% if forloop.first %}
                                    <div class="wrap-btn d-flex gap_10">
                                        <a href="{{ image.image.url }}" data-fancybox="gallery" class="tf-btn btn-bg-1" style="--button-width: 173.172px;">
                                            <span class="d-flex align-items-center gap_8"><i class="icon-Image"></i>Все фото</span>
                                            <span class="bg-effect"></span>
                                        </a>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% empty %}
                            <div class="swiper-slide" style="width: 926.078px; margin-right: 20px;">
                                <div class="thumb-main">
                                    <img width="930" height="620" src="{% static 'images/placeholder.jpg' %}" alt="{{ property.name }}">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="sw-button nav-prev-layout xl-hide" tabindex="0" role="button" aria-label="Previous slide">
                            <i class="icon-CaretLeft"></i>
                        </div>
                        <div class="sw-button nav-next-layout xl-hide" tabindex="0" role="button" aria-label="Next slide">
                            <i class="icon-CaretRight"></i>
                        </div>
                    <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span></div>
                </div>
                <div class="tf-container tf-spacing-7">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="properties-title ">
                                <div class="d-flex align-items-center justify-content-between flex-wrap gap_12">
                                    <div>
                                        <h1>{{ property.name }}</h1>
                                    </div>
                                </div>
                                
                            </div>
                            <div id="overview" class="section tf-spacing-9">
                            <div class="properties-overview v3 properties-2 tf-spacing-8" style="padding-top: 30px;">
                                <h5 class="properties-title mb_20">
                                    Характеристики
                                </h5>
                                <div class="tf-grid-layout tf-col-2 xl-col-4 md-col-3">
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-HouseSimple"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">ID</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.id }}</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-SlidersHorizontal"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Тип</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.property_type.name }}</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-Bed"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Комнат</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.rooms }}</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-Shower"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Город</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.location }}</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-Warehouse"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Гараж</span>
                                            <span class="text-title fw-6 text_primary-color">{% if property.has_garage %}Да{% else %}Нет{% endif %}</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-Ruler"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Площадь</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.area }} м²</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-Crop"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Океан</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.ocean_distance|default:"-" }} м</span>
                                        </div>
                                    </div>
                                    <div class="item d-flex gap_16">
                                        <i class="icon icon-CalendarBlank"></i>
                                        <div class="d-flex flex-column gap">
                                            <span class="text-body-default">Дата сдачи</span>
                                            <span class="text-title fw-6 text_primary-color">{{ property.completion_status }}</span>
                                        </div>
                                    </div>
                                </div>

                            </div>
                            </div>
                            
                            <div id="description" class="tf-spacing-9">
                                <div class="properties-description properties-2  ">
                                    <h5 class="properties-title mb_20">
                                        Описание объекта
                                    </h5>
                                    <p class="mb_8 text-body-2">
                                        {{ property.description|safe }}
                                    </p>
                                </div>
                            </div>
                            
                            <div id="location" class="section  tf-spacing-9">
                            <div class="properties-location v2 properties-2 tf-spacing-8">
                                <h5 class="properties-title mb_20">
                                    Расположение
                                </h5>
                                <div class="heading d-flex align-items-center justify-content-between flex-wrap gap_12 mb_16">
                                    <div class=" d-flex align-items-center gap_4 text-button fw-7 text_primary-color flex-wrap">
                                        <i class="icon-MapPin"></i>{{ property.address }}
                                    </div>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ property.address|urlencode }}" target="_blank" class="hover-underline-link text-button fw-7 text_primary-color">Построить маршрут</a>
                                </div>
                                <div class="wrap-map">
    <div id="map" class="mapboxgl-map" 
         data-lat="{{ property.latitude|default:'-8.6478' }}" 
         data-lng="{{ property.longitude|default:'115.1385' }}"
         data-title="{{ property.name }}">
    </div>
</div>
                            </div>
                            </div>
                            <div id="nearby" class="section tf-spacing-9">
                            <div class="properties-nearby properties-2">
                                <h5 class="properties-title mb_20">
                                    Что находится поблизости?
                                </h5>
                                <p class="text-body-2">{{ property.nearby_description|default:"Удобное расположение рядом с основными объектами инфраструктуры." }}</p>
                                <div class="wrap ">
                                    <ul class="col-nearby d-flex flex-column gap_8">
                                        <li>
                                            <span class="text-body-default">Школа:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_school|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Супермаркет:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_supermarket|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Клиника:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_clinic|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Парк:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_park|default:"-" }}</span>
                                        </li>
                                    </ul>
                                    <ul class="col-nearby d-flex flex-column gap_8">
                                        <li>
                                            <span class="text-body-default">Спортзал:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_gym|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Аптека:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_pharmacy|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Кафе:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_cafe|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Магазины:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_shopping|default:"-" }}</span>
                                        </li>
                                    </ul>
                                    <ul class="col-nearby d-flex flex-column gap_8">
                                        <li>
                                            <span class="text-body-default">Центр:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_center|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Пляж:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_beach|default:"-" }}</span>
                                        </li>
                                        <li>
                                            <span class="text-body-default">Аэропорт:</span>
                                            <span class="text-button fw-7 text_primary-color">{{ property.distance_airport|default:"-" }}</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            </div>
                            
                        </div>
                        <div class="col-lg-4">
                            <div class="right sticky-top" style="top: 105px;">
                                <div class="box-sellers mb_30" style="background-color: #fff;">
                                    <h5 class="mb_24">Застройщик</h5>
                                    <div class="author d-flex mb_24">
                                        <div class="avatar">
                                            {% if property.developer.logo %}
                                            <img src="{{ property.developer.logo.url }}" width="100" height="100" alt="{{ property.developer.name }}">
                                            {% endif %}
                                        </div>
                                        <div class="author-info d-flex flex-column">
                                            <h6 class="mb_8">{{ property.developer.name }}</h6>
                                            {% if property.developer.website %}
                                            <a href="{{ property.developer.website }}" target="_blank" class="text_secondary-color text-body-default link">Сайт компании <i class="icon-ArrowUpRight"></i></a>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <ul class="info mb_23">
                                        <div class="author-info d-flex flex-column">
                                            <span class="text-body-default">{{ property.developer.short_description_for_property|default:"" }}</span>
                                        </div>
                                    </ul>
                                    <a href="#" class="tf-btn btn-bg-1 w-full mb_12" style="--button-width: 362px;">
                                        <span class="d-flex align-items-center gap_8"><i class="icon-FilePdf"></i>Получить презентацию объекта</span>
                                        <span class="bg-effect"></span>
                                    </a>
                                    {% if property.developer.telegram %}
                                    <a href="{{ property.developer.telegram }}" target="_blank" class="tf-btn w-full" style="--button-width: 362px;">
                                        <span class="d-flex align-items-center gap_8"><i class="icon-ChatCircleDots"></i>Написать в Telegram</span>
                                        <span class="bg-effect"></span>
                                    </a>
                                    {% endif %}
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            {% if related_properties %}
            <div class="tf-container sw-layout tf-spacing-1 pt-0">
                <div class="heading-section mb_48">
                    <h3>Другие предложения</h3>
                </div>
                <div class="swiper swiper-initialized swiper-horizontal swiper-backface-hidden" data-preview="3" data-tablet="2" data-mobile-sm="2" data-mobile="1" data-space-lg="30" data-space-md="20" data-space="15">
                    <div class="swiper-wrapper" id="swiper-wrapper-8d755277c7abc148" aria-live="polite">
    {% if property.main_image %}
    <div class="swiper-slide" style="width: 926.078px; margin-right: 20px;" role="group" data-swiper-slide-index="0">
        <div class="thumb-main">
            <a href="{{ property.main_image.url }}" data-fancybox="gallery" class="img-style">
                <img width="930" height="620" loading="eager" decoding="async" src="{{ property.main_image.url }}" alt="{{ property.name }}">
            </a>
            <div class="wrap-btn d-flex gap_10">
                <a href="{{ property.main_image.url }}" data-fancybox="gallery" class="tf-btn btn-bg-1" style="--button-width: 173.172px;">
                    <span class="d-flex align-items-center gap_8"><i class="icon-Image"></i>Все фото</span>
                    <span class="bg-effect"></span>
                </a>
            </div>
        </div>
    </div>
    {% endif %}
    {% for image in property.images.all %}
    <div class="swiper-slide" style="width: 926.078px; margin-right: 20px;" role="group" data-swiper-slide-index="{{ forloop.counter }}">
        <div class="thumb-main">
            <a href="{{ image.image.url }}" data-fancybox="gallery" class="img-style">
                <img width="930" height="620" loading="eager" decoding="async" src="{{ image.image.url }}" alt="{{ property.name }}">
            </a>
        </div>
    </div>
    {% empty %}
    {% if not property.main_image %}
    <div class="swiper-slide" style="width: 926.078px; margin-right: 20px;">
        <div class="thumb-main">
            <img width="930" height="620" src="{% static 'images/placeholder.jpg' %}" alt="{{ property.name }}">
        </div>
    </div>
    {% endif %}
    {% endfor %}
</div>

                    <div class="sw-dots style-1 sw-pagination-layout text-center mt_24 swiper-pagination-clickable swiper-pagination-bullets swiper-pagination-horizontal"></div>
                <span class="swiper-notification" aria-live="assertive" aria-atomic="true"></span></div>
            </div>
            {% endif %}

        </div>
        
    <!-- /wrapper -->
<!-- Mobile Sticky Button -->
<div class="mobile-sticky-cta d-lg-none">
    <button type="button" class="tf-btn btn-bg-1 w-full" data-bs-toggle="modal" data-bs-target="#whatsappModal">
        <span class="d-flex align-items-center justify-content-center gap_8">
            <i class="icon-FilePdf"></i>Получить презентацию
        </span>
    </button>
</div>

<!-- WhatsApp Modal -->
<div class="modal fade" id="whatsappModal" tabindex="-1" aria-labelledby="whatsappModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="whatsappModalLabel">Получить презентацию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb_16">Оставьте ваш WhatsApp и мы отправим презентацию объекта</p>
                <form id="whatsappForm" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="source" value="property_{{ property.id }}">
                    <input type="hidden" name="name" value="WhatsApp запрос">
                    <fieldset class="mb_16">
                        <label class="text-button fw-7 text_primary-color mb_8">Ваш WhatsApp *</label>
                        <input type="tel" name="phone" placeholder="+62 812 3456 7890" required>
                    </fieldset>
                    <button type="submit" class="tf-btn btn-bg-1 w-full">
                        <span>Отправить</span>
                        <span class="bg-effect"></span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
<style>
.mobile-sticky-cta {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 12px 16px;
    background: #fff;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 1000;
}

.mobile-sticky-cta .tf-btn {
    padding: 14px 20px;
}

/* Отступ снизу для контента чтобы кнопка не перекрывала */
@media (max-width: 991px) {
    .main-content {
        padding-bottom: 80px;
    }
}
</style>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />

<script>
document.addEventListener('DOMContentLoaded', function() {
    const mapContainer = document.getElementById('map');
    if (!mapContainer) return;
    
    const lat = parseFloat(mapContainer.dataset.lat);
    const lng = parseFloat(mapContainer.dataset.lng);
    const title = mapContainer.dataset.title;
    
    mapboxgl.accessToken = "pk.eyJ1IjoiaG9hbmdoYW5kbiIsImEiOiJjbTdsbTkydm8wZGpiMmxxcTdvdzVqbHd3In0.HUUli-jvI1ALTBuzSeKTpw";
    
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/light-v10',
        center: [lng, lat],
        zoom: 15
    });
    
    // Контролы
    map.addControl(new mapboxgl.NavigationControl());
    map.addControl(new mapboxgl.FullscreenControl());
    map.addControl(new mapboxgl.GeolocateControl());
    
    // Маркер
    const markerEl = document.createElement('div');
    markerEl.className = 'office-marker';
    markerEl.innerHTML = '<i class="icon-HouseLine"></i>';
    
    new mapboxgl.Marker(markerEl)
        .setLngLat([lng, lat])
        .addTo(map);
});
</script>
{% endblock %}